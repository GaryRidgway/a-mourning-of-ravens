function pairSpaceAndScale(){const t=mourn.config.poemStaging.querySelectorAll(".stanza .line"),e=t.length;t.forEach(((n,a)=>{const o=n.querySelectorAll(".initiator").length>0,i=n.querySelectorAll(".terminator").length>0;let r=parseInt(n.getAttribute("data-char-count")),s=null;if(o?s=(a-1+e)%e:i&&(s=(a+1+e)%e),null!==s){r=(r+parseInt(t[s].getAttribute("data-char-count")))/2}const l=invLogScale(scale(r,mourn.staging.leastChars,mourn.staging.mostChars,1,10));n.style.setProperty("--char-spacing",l+"px");const c=invLogScale(scale(r,mourn.staging.leastChars,mourn.staging.mostChars,1,10));n.style.setProperty("--char-scaling",c+"px")}))}function addStanzasToStaging(t){t.forEach(((t,e)=>{const n=addStanzaToStaging(e),a=n.getBoundingClientRect().width;a>mourn.staging.widestStanza&&(mourn.staging.widestStanza=Math.ceil(a)),stanzaCountLineChars(n)}))}function addStanzaToStaging(t){const e=document.createElement("div");e.classList.add("stanza"),e.setAttribute("data-stanza-number",t);return stanzaContents(t).forEach((t=>{e.append(t)})),mourn.config.poemStaging.append(e),e}function stanzaContents(t){const e=poem_json[t];let n=[];for(let t=0;t<4;t++){let a="";0===t&&(a+='<span class="initiator">'+e.initiator+"</span>"),a+=lineTextFormat(e[t.toString()]),3===t&&(a+='<span class="terminator">'+e.terminator+"</span>"),n.push(lineElement(a))}return n}function lineTextFormat(t){let e="<span>";return e+=t.replaceAll(" ","</span> <span>"),e+="</span>",e}function lineElement(t){const e=document.createElement("div");e.classList.add("line"),e.innerHTML=t;const n=e.textContent.length;return e.setAttribute("data-char-count",n),e}function stanzaCountLineChars(t){Array.prototype.slice.call(t.children).forEach((t=>{const e=t.textContent.length;if(e>mourn.staging.mostChars){mourn.staging.mostChars=Math.ceil(e);const n=document.getElementById("most-line-characters");n&&n.removeAttribute("id"),t.setAttribute("id","most-line-characters")}else if(e<mourn.staging.leastChars){mourn.staging.leastChars=Math.floor(e);const n=document.getElementById("least-line-characters");n&&n.removeAttribute("id"),t.setAttribute("id","least-line-characters")}}))}function setStanzaOffsets(){mourn.config.poemStaging.childNodes.forEach(((t,e)=>{const n=t.getBoundingClientRect(),a=getDiagonalOfBB(n),o=(lineSlope(a),t.querySelector(".initiator").getBoundingClientRect()),i=getDiagonalOfBB(o),r=(lineSlope(i),t.querySelector(".terminator").getBoundingClientRect()),s=getDiagonalOfBB(r),l=(lineSlope(s),r.left-o.left),c=r.top-o.top,g=n.top-o.top;t.setAttribute("data-left-offset",l),t.setAttribute("data-top-offset",c),t.setAttribute("data-initiator-top-offset",g),t.setAttribute("data-terminator-width",s[1].x-s[0].x);const u=[a[0],{x:a[1].x-s[1].x,y:a[1].y-s[1].y}];t.setAttribute("data-slope",lineSlope(u)),t.setAttribute("data-scroll-width-begin",mourn.staging.fullScrollWidth);const d=a[1].x-s[1].x;mourn.staging.fullScrollWidth+=d,t.setAttribute("data-scroll-width",d),t.style.setProperty("--svg-width",d),t.style.setProperty("--svg-height",a[1].y-s[1].y)}))}function getDiagonalOfBB(t){return[{x:t.left-t.left,y:t.top-t.top},{x:t.right-t.left,y:t.bottom-t.top}]}